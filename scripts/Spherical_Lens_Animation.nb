(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     50517,       1420]
NotebookOptionsPosition[     49083,       1389]
NotebookOutlinePosition[     49565,       1406]
CellTagsIndexPosition[     49522,       1403]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["\<\

Spherical Lens Animation\
\>", "Title",
 CellFrame->{{0, 0}, {3, 0}},
 Evaluatable->False,
 CellFrameColor->GrayLevel[0.75],
 CellChangeTimes->{{3.866579453313022*^9, 3.86657945363702*^9}, 
   3.86657955134002*^9, {3.8665795849330225`*^9, 3.866579609321022*^9}},
 FormatType->
  "TextForm",ExpressionUUID->"f1b288ec-f984-4158-ba46-c82f3e5dbfff"],

Cell["Author: Jacopo Bertolotti", "Subtitle",
 CellChangeTimes->{{3.866579609679022*^9, 
  3.86657964211802*^9}},ExpressionUUID->"f13fd19f-f608-41c2-9277-\
54f71a15d5f1"],

Cell["\<\
\[OpenCurlyDoubleQuote]Visualization of light through a spherical lens, as a \
function of the radii of curvature of the two facets. Notice that we are far \
from the \[OpenCurlyDoubleQuote]thin lens\[CloseCurlyDoubleQuote] \
approximation.\[CloseCurlyDoubleQuote] - \
https://en.wikipedia.org/wiki/Lens#/media/File:Spherical_Lens.gif\
\>", "Abstract",
 CellChangeTimes->{{3.8665796431330204`*^9, 3.866579643532022*^9}, {
  3.866579703934022*^9, 
  3.866579713886021*^9}},ExpressionUUID->"f9d50f6a-e27e-4147-9bde-\
9eaa70d2aee4"],

Cell[CellGroupData[{

Cell["", "Author",
 CellChangeTimes->{{3.86657961248502*^9, 
  3.866579614500021*^9}},ExpressionUUID->"ef2a7c5e-1d69-4514-8d95-\
226d8ce0fe32"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"\[Lambda]0", "=", "1."}], ";", 
  RowBox[{"k0", "=", 
   RowBox[{"N", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"2", " ", "\[Pi]"}], ")"}], "/", "\[Lambda]0"}], "]"}]}], ";", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "The", " ", "wavelength", " ", "in", " ", "vacuum", " ", "is", " ", "set",
      " ", "to", " ", "1"}], ",", 
    RowBox[{
    "so", " ", "all", " ", "lengths", " ", "are", " ", "now", " ", "in", " ", 
     "units", " ", "of", " ", "wavelengths"}]}], "*)"}], 
  RowBox[{"\[Delta]", "=", 
   RowBox[{"\[Lambda]0", "/", "15"}]}], ";", 
  RowBox[{"\[CapitalDelta]", "=", 
   RowBox[{"40", "*", "\[Lambda]0"}]}], ";", 
  RowBox[{"(*", 
   RowBox[{"Parameters", " ", "for", " ", "the", " ", "grid"}], "*)"}], 
  RowBox[{"\[Sigma]", "=", 
   RowBox[{"10", " ", "\[Lambda]0"}]}], ";", 
  RowBox[{"(*", 
   RowBox[{"width", " ", "of", " ", "the", " ", "gaussian", " ", "beam"}], 
   "*)"}], 
  RowBox[{
   RowBox[{"sourcef", "[", 
    RowBox[{"x_", ",", "y_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"E", "^", 
     RowBox[{"(", 
      RowBox[{"-", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"x", "^", "2"}], "/", 
         RowBox[{"(", 
          RowBox[{"2", " ", 
           RowBox[{"\[Sigma]", "^", "2"}]}], ")"}]}], ")"}]}], ")"}]}], " ", 
    RowBox[{"E", "^", 
     RowBox[{"(", 
      RowBox[{"-", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{"y", "+", 
            RowBox[{"\[CapitalDelta]", "/", "2"}]}], ")"}], "^", "2"}], "/", 
         RowBox[{"(", 
          RowBox[{"2", " ", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"\[Lambda]0", "/", "2"}], ")"}], "^", "2"}]}], ")"}]}], 
        ")"}]}], ")"}]}], " ", 
    RowBox[{"E", "^", 
     RowBox[{"(", 
      RowBox[{"I", " ", "k0", " ", "y"}], ")"}]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"\[Phi]in", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Chop", "[", 
      RowBox[{"sourcef", "[", 
       RowBox[{"x", ",", "y"}], "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"x", ",", 
       RowBox[{
        RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
       RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"y", ",", 
       RowBox[{
        RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
       RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}]}], 
    "]"}]}], ";", 
  RowBox[{"(*", 
   RowBox[{"Discretized", " ", "source"}], "*)"}], 
  RowBox[{"d", "=", 
   RowBox[{"\[Lambda]0", "/", "2"}]}], ";", 
  RowBox[{"(*", 
   RowBox[{
   "typical", " ", "scale", " ", "of", " ", "the", " ", "absorbing", " ", 
    "layer"}], "*)"}], 
  RowBox[{"imn", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Chop", "[", 
      RowBox[{"5", " ", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"E", "^", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"x", "+", 
               RowBox[{"\[CapitalDelta]", "/", "2"}]}], ")"}], "/", "d"}], 
            ")"}]}]}], "+", 
         RowBox[{"E", "^", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"x", "-", 
              RowBox[{"\[CapitalDelta]", "/", "2"}]}], ")"}], "/", "d"}], 
           ")"}]}], "+", 
         RowBox[{"E", "^", 
          RowBox[{"-", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"y", "+", 
               RowBox[{"\[CapitalDelta]", "/", "2"}]}], ")"}], "/", "d"}], 
            ")"}]}]}], "+", 
         RowBox[{"E", "^", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"y", "-", 
              RowBox[{"\[CapitalDelta]", "/", "2"}]}], ")"}], "/", "d"}], 
           ")"}]}]}], ")"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"x", ",", 
       RowBox[{
        RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
       RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"y", ",", 
       RowBox[{
        RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
       RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}]}], 
    "]"}]}], ";", 
  RowBox[{"(*", 
   RowBox[{
   "Imaginary", " ", "part", " ", "of", " ", "the", " ", "refractive", " ", 
    "index", " ", 
    RowBox[{"(", 
     RowBox[{
     "used", " ", "to", " ", "emulate", " ", "absorbing", " ", "boundaries"}],
      ")"}]}], "*)"}], 
  RowBox[{"dim", "=", 
   RowBox[{
    RowBox[{"Dimensions", "[", "\[Phi]in", "]"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"L", "=", 
    RowBox[{
     RowBox[{
      RowBox[{"-", "1"}], "/", 
      RowBox[{"\[Delta]", "^", "2"}]}], "*", 
     RowBox[{"KirchhoffMatrix", "[", 
      RowBox[{"GridGraph", "[", 
       RowBox[{"{", 
        RowBox[{"dim", ",", "dim"}], "}"}], "]"}], "]"}]}]}], ";", 
   RowBox[{"(*", 
    RowBox[{"Discretized", " ", "Laplacian"}], "*)"}], 
   RowBox[{"ycenter", "=", 
    RowBox[{"Map", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"y0", "/.", " ", "#"}], "&"}], ",", 
      RowBox[{
       RowBox[{"FullSimplify", "[", 
        RowBox[{"Solve", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"(", "x1", ")"}], "^", "2"}], "+", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"y1", "-", "y0"}], ")"}], "^", "2"}]}], "==", 
           RowBox[{"r", "^", "2"}]}], ",", 
          RowBox[{"{", "y0", "}"}]}], "]"}], "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1", ",", "All"}], "]"}], "]"}]}], "]"}]}], ";"}],
   "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"surface2", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{"Evaluate", "[", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}], "+", "y0"}], ")"}],
         "/.", " ", 
        RowBox[{"{", 
         RowBox[{"y0", "->", 
          RowBox[{"ycenter", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"y1", "->", 
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
        RowBox[{"x1", "->", 
         RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
        RowBox[{"r", "->", 
         RowBox[{"100", " ", "\[CapitalDelta]"}]}]}], "}"}]}], "]"}], "]"}]}],
   ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"surface1", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}]}], "+", "y0", "-", 
         "1"}], ")"}], "/.", " ", 
       RowBox[{"{", 
        RowBox[{"y0", "->", 
         RowBox[{"ycenter", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"y1", "->", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
       RowBox[{"x1", "->", 
        RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
       RowBox[{"r", "->", 
        RowBox[{"100", " ", "\[CapitalDelta]"}]}]}], "}"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"frames1", "=", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"ren", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"y", "<", 
              RowBox[{"Re", "@", 
               RowBox[{"Evaluate", "[", 
                RowBox[{"surface2", "[", "x", "]"}], "]"}]}]}], "&&", 
             RowBox[{"y", ">", 
              RowBox[{"Re", "@", 
               RowBox[{"surface1", "[", "x", "]"}]}]}]}], ",", "n0", ",", 
            "1"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"x", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"y", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}]}],
          "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", "=", 
        RowBox[{"ren", "+", 
         RowBox[{"I", " ", "imn"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"b", "=", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], "-", "1"}], 
           ")"}]}], " ", 
         RowBox[{"k0", "^", "2"}], " ", 
         RowBox[{"Flatten", "[", "\[Phi]in", "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Right", "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"M", "=", 
        RowBox[{"L", "+", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"SparseArray", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], " ", 
            RowBox[{"k0", "^", "2"}]}], "]"}], "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Operator", " ", "on", " ", "the", " ", "left"}], "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"\[Phi]s", "=", 
        RowBox[{"Partition", "[", 
         RowBox[{
          RowBox[{"LinearSolve", "[", 
           RowBox[{"M", ",", "b"}], "]"}], ",", "dim"}], "]"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Solve", " ", "the", " ", "linear", " ", "system"}], "*)"}], 
       RowBox[{"ImageAdd", "[", 
        RowBox[{
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Abs", "[", 
                 RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "/", 
                RowBox[{"Max", "[", 
                 RowBox[{"Abs", "[", 
                  RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "]"}]}], ")"}],
               "^", "2"}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", "\[Delta]"}]}], 
              ",", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", 
                "\[Delta]"}]}]}], "]"}], "]"}], ",", 
           RowBox[{"ColorFunction", "->", "\"\<AvocadoColors\>\""}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"Frame", "->", "False"}], ",", 
           RowBox[{"PlotRange", "->", 
            RowBox[{"{", 
             RowBox[{"0", ",", "1"}], "}"}]}]}], "]"}], ",", 
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{"Transpose", "@", 
            RowBox[{"Re", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"n", "-", "1"}], ")"}], "/", "5"}], "]"}]}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"ColorFunctionScaling", "->", "False"}], ",", 
           RowBox[{"ColorFunction", "->", "GrayLevel"}], ",", 
           RowBox[{"Frame", "->", "False"}]}], "]"}]}], "]"}]}], 
      RowBox[{"(*", 
       RowBox[{"Plot", " ", "everything"}], "*)"}], ",", 
      RowBox[{"{", 
       RowBox[{"n0", ",", "1", ",", "2.5", ",", "0.24"}], "}"}]}], "]"}]}], 
   ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"surface2", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{"Evaluate", "[", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}], "+", "y0"}], ")"}],
         "/.", " ", 
        RowBox[{"{", 
         RowBox[{"y0", "->", 
          RowBox[{"ycenter", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"y1", "->", 
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
        RowBox[{"x1", "->", 
         RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
        RowBox[{"r", "->", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"c", "^", "2"}], "+", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"c", " ", "\[CapitalDelta]"}], ")"}], "/", "2"}], "+", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"5", " ", 
               RowBox[{"\[CapitalDelta]", "^", "2"}]}], ")"}], "/", "16"}]}], 
           ")"}], "/", 
          RowBox[{"(", 
           RowBox[{"2", " ", 
            RowBox[{"(", 
             RowBox[{"c", "+", 
              RowBox[{"\[CapitalDelta]", "/", "4"}]}], ")"}]}], ")"}]}]}]}], 
       "}"}]}], "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"surface1", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}]}], "+", "y0", "-", 
         "1"}], ")"}], "/.", " ", 
       RowBox[{"{", 
        RowBox[{"y0", "->", 
         RowBox[{"ycenter", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"y1", "->", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
       RowBox[{"x1", "->", 
        RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
       RowBox[{"r", "->", 
        RowBox[{"100", " ", "\[CapitalDelta]"}]}]}], "}"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"frames2", "=", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"ren", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"y", "<", 
              RowBox[{"Re", "@", 
               RowBox[{"Evaluate", "[", 
                RowBox[{"surface2", "[", "x", "]"}], "]"}]}]}], "&&", 
             RowBox[{"y", ">", 
              RowBox[{"Re", "@", 
               RowBox[{"surface1", "[", "x", "]"}]}]}]}], ",", "2.5", ",", 
            "1"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"x", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"y", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}]}],
          "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", "=", 
        RowBox[{"ren", "+", 
         RowBox[{"I", " ", "imn"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"b", "=", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], "-", "1"}], 
           ")"}]}], " ", 
         RowBox[{"k0", "^", "2"}], " ", 
         RowBox[{"Flatten", "[", "\[Phi]in", "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Right", "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"M", "=", 
        RowBox[{"L", "+", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"SparseArray", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], " ", 
            RowBox[{"k0", "^", "2"}]}], "]"}], "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Operator", " ", "on", " ", "the", " ", "left"}], "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"\[Phi]s", "=", 
        RowBox[{"Partition", "[", 
         RowBox[{
          RowBox[{"LinearSolve", "[", 
           RowBox[{"M", ",", "b"}], "]"}], ",", "dim"}], "]"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Solve", " ", "the", " ", "linear", " ", "system"}], "*)"}], 
       RowBox[{"ImageAdd", "[", 
        RowBox[{
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Abs", "[", 
                 RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "/", 
                RowBox[{"Max", "[", 
                 RowBox[{"Abs", "[", 
                  RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "]"}]}], ")"}],
               "^", "2"}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", "\[Delta]"}]}], 
              ",", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", 
                "\[Delta]"}]}]}], "]"}], "]"}], ",", 
           RowBox[{"ColorFunction", "->", "\"\<AvocadoColors\>\""}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"Frame", "->", "False"}], ",", 
           RowBox[{"PlotRange", "->", 
            RowBox[{"{", 
             RowBox[{"0", ",", "1"}], "}"}]}]}], "]"}], ",", 
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{"Transpose", "@", 
            RowBox[{"Re", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"n", "-", "1"}], ")"}], "/", "5"}], "]"}]}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"ColorFunctionScaling", "->", "False"}], ",", 
           RowBox[{"ColorFunction", "->", "GrayLevel"}], ",", 
           RowBox[{"Frame", "->", "False"}]}], "]"}]}], "]"}]}], 
      RowBox[{"(*", 
       RowBox[{"Plot", " ", "everything"}], "*)"}], ",", 
      RowBox[{"{", 
       RowBox[{"c", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}], "+", "0.01"}], ",",
         "0", ",", 
        RowBox[{"\[CapitalDelta]", "/", 
         RowBox[{"(", 
          RowBox[{"20", "*", "3"}], ")"}]}]}], "}"}]}], "]"}]}], ";"}], 
  "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"surface2", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{"Evaluate", "[", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}], "+", "y0"}], ")"}],
         "/.", " ", 
        RowBox[{"{", 
         RowBox[{"y0", "->", 
          RowBox[{"ycenter", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"y1", "->", 
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
        RowBox[{"x1", "->", 
         RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
        RowBox[{"r", "->", 
         RowBox[{
          RowBox[{"5", "/", "8"}], " ", "\[CapitalDelta]"}]}]}], "}"}]}], 
     "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"surface1", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}]}], "+", "y0", "-", 
         "1"}], ")"}], "/.", " ", 
       RowBox[{"{", 
        RowBox[{"y0", "->", 
         RowBox[{"ycenter", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"y1", "->", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
       RowBox[{"x1", "->", 
        RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
       RowBox[{"r", "->", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"c", "^", "2"}], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"c", " ", "\[CapitalDelta]"}], ")"}], "/", "2"}], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"5", " ", 
              RowBox[{"\[CapitalDelta]", "^", "2"}]}], ")"}], "/", "16"}]}], 
          ")"}], "/", 
         RowBox[{"(", 
          RowBox[{"2", " ", 
           RowBox[{"(", 
            RowBox[{"c", "+", 
             RowBox[{"\[CapitalDelta]", "/", "4"}]}], ")"}]}], ")"}]}]}]}], 
      "}"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"frames3", "=", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"ren", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"y", "<", 
              RowBox[{"Re", "@", 
               RowBox[{"Evaluate", "[", 
                RowBox[{"surface2", "[", "x", "]"}], "]"}]}]}], "&&", 
             RowBox[{"y", ">", 
              RowBox[{"Re", "@", 
               RowBox[{"surface1", "[", "x", "]"}]}]}]}], ",", "2.5", ",", 
            "1"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"x", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"y", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}]}],
          "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", "=", 
        RowBox[{"ren", "+", 
         RowBox[{"I", " ", "imn"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"b", "=", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], "-", "1"}], 
           ")"}]}], " ", 
         RowBox[{"k0", "^", "2"}], " ", 
         RowBox[{"Flatten", "[", "\[Phi]in", "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Right", "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"M", "=", 
        RowBox[{"L", "+", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"SparseArray", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], " ", 
            RowBox[{"k0", "^", "2"}]}], "]"}], "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Operator", " ", "on", " ", "the", " ", "left"}], "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"\[Phi]s", "=", 
        RowBox[{"Partition", "[", 
         RowBox[{
          RowBox[{"LinearSolve", "[", 
           RowBox[{"M", ",", "b"}], "]"}], ",", "dim"}], "]"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Solve", " ", "the", " ", "linear", " ", "system"}], "*)"}], 
       RowBox[{"ImageAdd", "[", 
        RowBox[{
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Abs", "[", 
                 RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "/", 
                RowBox[{"Max", "[", 
                 RowBox[{"Abs", "[", 
                  RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "]"}]}], ")"}],
               "^", "2"}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", "\[Delta]"}]}], 
              ",", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", 
                "\[Delta]"}]}]}], "]"}], "]"}], ",", 
           RowBox[{"ColorFunction", "->", "\"\<AvocadoColors\>\""}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"Frame", "->", "False"}], ",", 
           RowBox[{"PlotRange", "->", 
            RowBox[{"{", 
             RowBox[{"0", ",", "1"}], "}"}]}]}], "]"}], ",", 
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{"Transpose", "@", 
            RowBox[{"Re", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"n", "-", "1"}], ")"}], "/", "5"}], "]"}]}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"ColorFunctionScaling", "->", "False"}], ",", 
           RowBox[{"ColorFunction", "->", "GrayLevel"}], ",", 
           RowBox[{"Frame", "->", "False"}]}], "]"}]}], "]"}]}], 
      RowBox[{"(*", 
       RowBox[{"Plot", " ", "everything"}], "*)"}], ",", 
      RowBox[{"{", 
       RowBox[{"c", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}], "+", "0.01"}], ",", 
        RowBox[{
         RowBox[{"-", "\[CapitalDelta]"}], "/", "10"}], ",", 
        RowBox[{"\[CapitalDelta]", "/", 
         RowBox[{"(", 
          RowBox[{"20", "*", "3"}], ")"}]}]}], "}"}]}], "]"}]}], ";"}], 
  "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"surface2", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{"Evaluate", "[", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}], "+", "y0"}], ")"}],
         "/.", " ", 
        RowBox[{"{", 
         RowBox[{"y0", "->", 
          RowBox[{"ycenter", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"y1", "->", 
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
        RowBox[{"x1", "->", 
         RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
        RowBox[{"r", "->", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"c", "^", "2"}], "+", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"c", " ", "\[CapitalDelta]"}], ")"}], "/", "2"}], "+", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"5", " ", 
               RowBox[{"\[CapitalDelta]", "^", "2"}]}], ")"}], "/", "16"}]}], 
           ")"}], "/", 
          RowBox[{"(", 
           RowBox[{"2", " ", 
            RowBox[{"(", 
             RowBox[{"c", "+", 
              RowBox[{"\[CapitalDelta]", "/", "4"}]}], ")"}]}], ")"}]}]}]}], 
       "}"}]}], "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"surface1", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}]}], "+", "y0", "-", 
         "1"}], ")"}], "/.", " ", 
       RowBox[{"{", 
        RowBox[{"y0", "->", 
         RowBox[{"ycenter", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"y1", "->", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
       RowBox[{"x1", "->", 
        RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
       RowBox[{"r", "->", 
        RowBox[{
         RowBox[{"109", "/", "120"}], " ", "\[CapitalDelta]"}]}]}], "}"}]}], 
    "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"frames4", "=", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"ren", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"y", "<", 
              RowBox[{"Re", "@", 
               RowBox[{"Evaluate", "[", 
                RowBox[{"surface2", "[", "x", "]"}], "]"}]}]}], "&&", 
             RowBox[{"y", ">", 
              RowBox[{"Re", "@", 
               RowBox[{"surface1", "[", "x", "]"}]}]}]}], ",", "2.5", ",", 
            "1"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"x", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"y", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}]}],
          "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", "=", 
        RowBox[{"ren", "+", 
         RowBox[{"I", " ", "imn"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"b", "=", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], "-", "1"}], 
           ")"}]}], " ", 
         RowBox[{"k0", "^", "2"}], " ", 
         RowBox[{"Flatten", "[", "\[Phi]in", "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Right", "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"M", "=", 
        RowBox[{"L", "+", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"SparseArray", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], " ", 
            RowBox[{"k0", "^", "2"}]}], "]"}], "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Operator", " ", "on", " ", "the", " ", "left"}], "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"\[Phi]s", "=", 
        RowBox[{"Partition", "[", 
         RowBox[{
          RowBox[{"LinearSolve", "[", 
           RowBox[{"M", ",", "b"}], "]"}], ",", "dim"}], "]"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Solve", " ", "the", " ", "linear", " ", "system"}], "*)"}], 
       RowBox[{"ImageAdd", "[", 
        RowBox[{
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Abs", "[", 
                 RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "/", 
                RowBox[{"Max", "[", 
                 RowBox[{"Abs", "[", 
                  RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "]"}]}], ")"}],
               "^", "2"}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", "\[Delta]"}]}], 
              ",", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", 
                "\[Delta]"}]}]}], "]"}], "]"}], ",", 
           RowBox[{"ColorFunction", "->", "\"\<AvocadoColors\>\""}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"Frame", "->", "False"}], ",", 
           RowBox[{"PlotRange", "->", 
            RowBox[{"{", 
             RowBox[{"0", ",", "1"}], "}"}]}]}], "]"}], ",", 
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{"Transpose", "@", 
            RowBox[{"Re", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"n", "-", "1"}], ")"}], "/", "5"}], "]"}]}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"ColorFunctionScaling", "->", "False"}], ",", 
           RowBox[{"ColorFunction", "->", "GrayLevel"}], ",", 
           RowBox[{"Frame", "->", "False"}]}], "]"}]}], "]"}]}], 
      RowBox[{"(*", 
       RowBox[{"Plot", " ", "everything"}], "*)"}], ",", 
      RowBox[{"{", 
       RowBox[{"c", ",", "0", ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}], "+", "0.01"}], ",", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"\[CapitalDelta]", "/", 
           RowBox[{"(", 
            RowBox[{"20", "*", "3"}], ")"}]}], ")"}]}]}], "}"}]}], "]"}]}], 
   ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"surface2", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{"Evaluate", "[", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}], "+", "y0"}], ")"}],
         "/.", " ", 
        RowBox[{"{", 
         RowBox[{"y0", "->", 
          RowBox[{"ycenter", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"y1", "->", 
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
        RowBox[{"x1", "->", 
         RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
        RowBox[{"r", "->", 
         RowBox[{"100", " ", "\[CapitalDelta]"}]}]}], "}"}]}], "]"}], "]"}]}],
   ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"surface1", "[", "x_", "]"}], ":=", 
   RowBox[{"Evaluate", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{"r", "^", "2"}], "-", 
            RowBox[{
             RowBox[{"(", "x", ")"}], "^", "2"}]}], "]"}]}], "+", "y0", "-", 
         "1"}], ")"}], "/.", " ", 
       RowBox[{"{", 
        RowBox[{"y0", "->", 
         RowBox[{"ycenter", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], ")"}], "/.", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"y1", "->", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}]}], ",", 
       RowBox[{"x1", "->", 
        RowBox[{"\[CapitalDelta]", "/", "2"}]}], ",", 
       RowBox[{"r", "->", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"c", "^", "2"}], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"c", " ", "\[CapitalDelta]"}], ")"}], "/", "2"}], "+", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"5", " ", 
              RowBox[{"\[CapitalDelta]", "^", "2"}]}], ")"}], "/", "16"}]}], 
          ")"}], "/", 
         RowBox[{"(", 
          RowBox[{"2", " ", 
           RowBox[{"(", 
            RowBox[{"c", "+", 
             RowBox[{"\[CapitalDelta]", "/", "4"}]}], ")"}]}], ")"}]}]}]}], 
      "}"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"frames5", "=", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"ren", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"y", "<", 
              RowBox[{"Re", "@", 
               RowBox[{"Evaluate", "[", 
                RowBox[{"surface2", "[", "x", "]"}], "]"}]}]}], "&&", 
             RowBox[{"y", ">", 
              RowBox[{"Re", "@", 
               RowBox[{"surface1", "[", "x", "]"}]}]}]}], ",", "2.5", ",", 
            "1"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"x", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"y", ",", 
            RowBox[{
             RowBox[{"-", "\[CapitalDelta]"}], "/", "2"}], ",", 
            RowBox[{"\[CapitalDelta]", "/", "2"}], ",", "\[Delta]"}], "}"}]}],
          "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", "=", 
        RowBox[{"ren", "+", 
         RowBox[{"I", " ", "imn"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"b", "=", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], "-", "1"}], 
           ")"}]}], " ", 
         RowBox[{"k0", "^", "2"}], " ", 
         RowBox[{"Flatten", "[", "\[Phi]in", "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Right", "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"M", "=", 
        RowBox[{"L", "+", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"SparseArray", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "[", "n", "]"}], "^", "2"}], " ", 
            RowBox[{"k0", "^", "2"}]}], "]"}], "]"}]}]}], ";", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Operator", " ", "on", " ", "the", " ", "left"}], "-", 
         RowBox[{
         "hand", " ", "side", " ", "of", " ", "the", " ", "equation", " ", 
          "we", " ", "want", " ", "to", " ", "solve"}]}], "*)"}], 
       RowBox[{"\[Phi]s", "=", 
        RowBox[{"Partition", "[", 
         RowBox[{
          RowBox[{"LinearSolve", "[", 
           RowBox[{"M", ",", "b"}], "]"}], ",", "dim"}], "]"}]}], ";", 
       RowBox[{"(*", 
        RowBox[{"Solve", " ", "the", " ", "linear", " ", "system"}], "*)"}], 
       RowBox[{"ImageAdd", "[", 
        RowBox[{
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Abs", "[", 
                 RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "/", 
                RowBox[{"Max", "[", 
                 RowBox[{"Abs", "[", 
                  RowBox[{"\[Phi]in", "+", "\[Phi]s"}], "]"}], "]"}]}], ")"}],
               "^", "2"}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", "\[Delta]"}]}], 
              ",", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"4", " ", "d"}], ")"}], "/", "\[Delta]"}], ";;", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "4"}], " ", "d"}], ")"}], "/", 
                "\[Delta]"}]}]}], "]"}], "]"}], ",", 
           RowBox[{"ColorFunction", "->", "\"\<AvocadoColors\>\""}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"Frame", "->", "False"}], ",", 
           RowBox[{"PlotRange", "->", 
            RowBox[{"{", 
             RowBox[{"0", ",", "1"}], "}"}]}]}], "]"}], ",", 
         RowBox[{"ArrayPlot", "[", 
          RowBox[{
           RowBox[{"Transpose", "@", 
            RowBox[{"Re", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"n", "-", "1"}], ")"}], "/", "5"}], "]"}]}], ",", 
           RowBox[{"DataReversed", "->", "True"}], ",", 
           RowBox[{"ColorFunctionScaling", "->", "False"}], ",", 
           RowBox[{"ColorFunction", "->", "GrayLevel"}], ",", 
           RowBox[{"Frame", "->", "False"}]}], "]"}]}], "]"}]}], 
      RowBox[{"(*", 
       RowBox[{"Plot", " ", "everything"}], "*)"}], ",", 
      RowBox[{"{", 
       RowBox[{"c", ",", 
        RowBox[{
         RowBox[{"-", "\[CapitalDelta]"}], "/", "10"}], ",", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"(", 
           RowBox[{"\[CapitalDelta]", "/", "4"}], ")"}]}], "+", "0.01"}], ",", 
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"\[CapitalDelta]", "/", 
           RowBox[{"(", 
            RowBox[{"20", "*", "3"}], ")"}]}], ")"}]}]}], "}"}]}], "]"}]}], 
   ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{"ListAnimate", "[", 
  RowBox[{"Flatten", "[", 
   RowBox[{"Join", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"frames1", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"{", "5", "}"}]}], "]"}], ",", "frames1", ",", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"frames2", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"{", "5", "}"}]}], "]"}], ",", "frames2", ",", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"frames3", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"{", "5", "}"}]}], "]"}], ",", "frames3", ",", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"frames4", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"{", "5", "}"}]}], "]"}], ",", "frames4", ",", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"frames5", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"{", "5", "}"}]}], "]"}], ",", "frames5", ",", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"frames1", "[", 
        RowBox[{"[", 
         RowBox[{"-", "1"}], "]"}], "]"}], ",", 
       RowBox[{"{", "5", "}"}]}], "]"}], ",", 
     RowBox[{"Reverse", "@", "frames1"}]}], "]"}], "]"}], "]"}]}], "Input",
 CellChangeTimes->{{3.86657932326826*^9, 3.866579323269261*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"95100426-1b67-4b04-aded-c87312f18264"],

Cell[BoxData[
 TemplateBox[{
  "General", "munfl", 
   "\"\\!\\(\\*RowBox[{\\\"0.1353352832366127`\\\", \\\" \\\", \
\\\"1.0137167725814463`*^-307\\\"}]\\) is too small to represent as a \
normalized machine number; precision may be lost.\"", 2, 2, 1, 
   31791515965305883143, "Local"},
  "MessageTemplate"]], "Message", "MSG",
 CellChangeTimes->{3.8665793255124345`*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"a6840086-3188-4ace-980f-64a581aa8f6f"],

Cell[BoxData[
 TemplateBox[{
  "General", "munfl", 
   "\"\\!\\(\\*RowBox[{\\\"Exp\\\", \\\"[\\\", RowBox[{\\\"-\\\", \
\\\"711.9022222222222`\\\"}], \\\"]\\\"}]\\) is too small to represent as a \
normalized machine number; precision may be lost.\"", 2, 2, 2, 
   31791515965305883143, "Local"},
  "MessageTemplate"]], "Message", "MSG",
 CellChangeTimes->{3.8665793255674305`*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"158c8795-c73e-4e43-8695-f85d55f26eab"],

Cell[BoxData[
 TemplateBox[{
  "General", "munfl", 
   "\"\\!\\(\\*RowBox[{\\\"Exp\\\", \\\"[\\\", RowBox[{\\\"-\\\", \
\\\"716.9422222222222`\\\"}], \\\"]\\\"}]\\) is too small to represent as a \
normalized machine number; precision may be lost.\"", 2, 2, 3, 
   31791515965305883143, "Local"},
  "MessageTemplate"]], "Message", "MSG",
 CellChangeTimes->{3.8665793255774307`*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"c264d76b-ef80-4c15-b506-2ab0e20167c5"],

Cell[BoxData[
 TemplateBox[{
  "General", "stop", 
   "\"Further output of \\!\\(\\*StyleBox[RowBox[{\\\"General\\\", \
\\\"::\\\", \\\"munfl\\\"}], \\\"MessageName\\\"]\\) will be suppressed \
during this calculation.\"", 2, 2, 4, 31791515965305883143, "Local"},
  "MessageTemplate"]], "Message", "MSG",
 CellChangeTimes->{3.866579325584431*^9},
 CellLabel->
  "During evaluation of \
In[1]:=",ExpressionUUID->"260a3469-d7a9-4cd0-83ae-078f58f4475c"]
}, Open  ]],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.866579930217969*^9, 
  3.8665799304349794`*^9}},ExpressionUUID->"24c28f3b-a817-4836-a017-\
932cf887509e"]
}, Open  ]]
}, Open  ]]
},
WindowSize->{718.5, 736.875},
WindowMargins->{{Automatic, -4.125}, {Automatic, 0}},
FrontEndVersion->"13.0 for Microsoft Windows (64-bit) (February 4, 2022)",
StyleDefinitions->FrontEnd`FileName[{"Article"}, "JournalArticle.nb", 
  CharacterEncoding -> "UTF-8"],
ExpressionUUID->"bed300bd-7c11-4645-80e4-35c7ed04dd81"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 356, 10, 125, "Title",ExpressionUUID->"f1b288ec-f984-4158-ba46-c82f3e5dbfff",
 Evaluatable->False],
Cell[939, 34, 170, 3, 29, "Subtitle",ExpressionUUID->"f13fd19f-f608-41c2-9277-54f71a15d5f1"],
Cell[1112, 39, 539, 10, 111, "Abstract",ExpressionUUID->"f9d50f6a-e27e-4147-9bde-9eaa70d2aee4"],
Cell[CellGroupData[{
Cell[1676, 53, 143, 3, 22, "Author",ExpressionUUID->"ef2a7c5e-1d69-4514-8d95-226d8ce0fe32"],
Cell[CellGroupData[{
Cell[1844, 60, 45134, 1268, 2541, "Input",ExpressionUUID->"95100426-1b67-4b04-aded-c87312f18264"],
Cell[46981, 1330, 476, 11, 28, "Message",ExpressionUUID->"a6840086-3188-4ace-980f-64a581aa8f6f"],
Cell[47460, 1343, 485, 11, 28, "Message",ExpressionUUID->"158c8795-c73e-4e43-8695-f85d55f26eab"],
Cell[47948, 1356, 485, 11, 28, "Message",ExpressionUUID->"c264d76b-ef80-4c15-b506-2ab0e20167c5"],
Cell[48436, 1369, 450, 10, 28, "Message",ExpressionUUID->"260a3469-d7a9-4cd0-83ae-078f58f4475c"]
}, Open  ]],
Cell[48901, 1382, 154, 3, 29, InheritFromParent,ExpressionUUID->"24c28f3b-a817-4836-a017-932cf887509e"]
}, Open  ]]
}, Open  ]]
}
]
*)

